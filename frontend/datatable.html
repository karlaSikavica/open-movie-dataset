<!DOCTYPE html>
<html lang="hr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Open Movie Dataset</title>
    <meta
      name="description"
      content="Tablični prikaz i filtriranje otvorenog skupa podataka o filmovima."
    />
    <meta name="author" content="Karla Sikavica" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="container">
      <nav class="navbar" aria-label="Navigacija">
        <div class="nav-left">
          <a href="./index.html" class="natrag">< natrag</a>
          <span id="authBadge" class="badge">Provjera prijave...</span>
        </div>

        <div class="nav-right">
          <a id="loginBtn" class="btn" href="/login">Prijava</a>
          <a
            id="profileBtn"
            class="btn ghost"
            href="./profile.html"
            style="display: none"
            >Korisnički profil</a
          >
          <a id="refreshBtn" class="btn ghost" href="#" style="display: none"
            >Osvježi preslike</a
          >
          <span id="toast" class="toast" style="display: none"></span>

          <a id="logoutBtn" class="btn" href="/odjava" style="display: none"
            >Odjava</a
          >
        </div>
      </nav>
    </header>

    <main class="container">
      <form id="filterForm" class="filters card" aria-label="Filter podataka">
        <div class="field">
          <label for="atribut">Atribut</label>
          <select id="atribut" name="field">
            <option value="*">Svi atributi</option>
            <option value="FilmID">FilmID</option>
            <option value="Naziv filma">Naziv filma</option>
            <option value="Godina">Godina</option>
            <option value="Zanr">Zanr</option>
            <option value="Zemlja nastanka filma">Zemlja nastanka filma</option>
            <option value="Trajanje filma">Trajanje filma</option>
            <option value="Ime redatelja">Ime redatelja</option>
            <option value="Prezime redatelja">Prezime redatelja</option>
            <option value="Budzet mil USD">Budzet mil USD</option>
            <option value="Prosjecna ocjena">Prosjecna ocjena</option>
            <option value="IMDB ocjena">IMDB ocjena</option>
            <option value="Rotten tomatoes ocjena">
              Rotten tomatoes ocjena
            </option>
            <option value="TMDB ocjena">TMDB ocjena</option>
            <option value="Ime glumca">Ime glumca</option>
            <option value="Prezime glumca">Prezime glumca</option>
            <option value="Uloga">Uloga</option>
            <option value="Spol">Spol</option>
            <option value="Datum rodenja">Datum rodenja</option>
            <option value="Drzava podrijetla">Drzava podrijetla</option>
            <option value="Aktivan od">Aktivan od</option>
            <option value="Broj nagrada">Broj nagrada</option>
            <option value="Oscar">Oscar</option>
            <option value="Golden globe">Golden globe</option>
            <option value="Bafta">Bafta</option>
          </select>
        </div>
        <div class="field">
          <label for="pretraga">Pretraži</label>
          <input
            id="pretraga"
            name="search"
            type="search"
            placeholder="npr. Nolan, Drama, 2014..."
            autocomplete="off"
          />
        </div>

        <div class="actions">
          <button type="submit" class="btn" id="gumb">Primijeni</button>
          <button type="button" id="resetBtn" class="btn ghost">Poništi</button>
        </div>
      </form>

      <section class="card">
        <div class="table-actions">
          <div class="left">
            <strong id="countInfo">Prikazano: 0</strong>
          </div>
          <div class="right">
            <a id="dlCsv" class="btn" href="/api/filmovi.csv" download
              >Preuzmi CSV (filtrirano)</a
            >
            <a id="dlJson" class="btn" href="/api/filmovi.json" download
              >Preuzmi JSON (filtrirano)</a
            >
          </div>
        </div>

        <div class="table-wrap">
          <table
            id="tablica"
            class="table"
            role="table"
            aria-label="Tablica filmova"
          >
            <thead>
              <tr>
                <th>ID</th>
                <th>Naziv</th>
                <th>Godina</th>
                <th>Zemlja</th>
                <th>Trajanje</th>
                <th>Žanr</th>
                <th>Redatelj</th>
                <th>IMDb</th>
                <th>RT</th>
                <th>TMDB</th>
                <th>Prosj.</th>
                <th>Budžet (M$)</th>
                <th>Glumac</th>
                <th>Uloga</th>
                <th>Spol</th>
                <th>Datum rođenja</th>
                <th>Država podrijetla</th>
                <th>Aktivan od</th>
                <th>Broj nagrada</th>
                <th>Oscar</th>
                <th>Golden Globe</th>
                <th>Bafta</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="container foot"></footer>

    <script>
      const form = document.getElementById("filterForm");
      const qInput = document.getElementById("pretraga");
      const fieldSelect = document.getElementById("atribut");
      const tableBody = document.querySelector("#tablica tbody");
      const countInfo = document.getElementById("countInfo");
      const resetBtn = document.getElementById("resetBtn");
      const dlCsv = document.getElementById("dlCsv");
      const dlJson = document.getElementById("dlJson");

      function buildQueryParams() {
        const q = qInput.value.trim();
        const field = fieldSelect.value || "all";
        const params = new URLSearchParams();
        if (q) params.set("search", q);
        if (field && field !== "all") params.set("field", field);
        return params.toString();
      }

      function updateDownloadLinks() {
        const qs = buildQueryParams();
        dlCsv.href = "/api/filmovi.csv" + (qs ? "?" + qs : "");
        dlJson.href = "/api/filmovi.json" + (qs ? "?" + qs : "");
      }

      async function fetchData() {
        const qs = buildQueryParams();
        const url = "/api/filmovi-view" + (qs ? "?" + qs : "");

        const res = await fetch(url);
        if (!res.ok) {
          tableBody.innerHTML =
            '<tr><td colspan="22">Greška pri dohvaćanju podataka.</td></tr>';
          countInfo.textContent = "Prikazano: 0";
          return;
        }

        const payload = await res.json();
        const data = payload.response || [];

        if (!Array.isArray(data) || data.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="22">Nema rezultata za zadani filter.</td></tr>';
          countInfo.textContent = "Prikazano: 0";
        } else {
          const rows = data
            .map((row) => {
              const redatelj = [row.redatelj_ime, row.redatelj_prezime]
                .filter(Boolean)
                .join(" ");

              const glumac = [row.ime, row.prezime].filter(Boolean).join(" ");

              return `
                <tr>
                  <td>${row.film_id ?? ""}</td>
                  <td>${row.naziv ?? ""}</td>
                  <td>${row.godina ?? ""}</td>
                  <td>${row.zemlja ?? ""}</td>
                  <td>${row.trajanje_min ?? ""}</td>
                  <td>${row.zanr ?? ""}</td>
                  <td>${redatelj}</td>
                  <td>${row.ocjena_imdb ?? ""}</td>
                  <td>${row.ocjena_rotten_tomatoes ?? ""}</td>
                  <td>${row.ocjena_tmdb ?? ""}</td>
                  <td>${row.prosjecna_ocjena ?? ""}</td>
                  <td>${row.budzet_mil_usd ?? ""}</td>
                  <td>${glumac}</td>
                  <td>${row.uloga ?? ""}</td>
                  <td>${row.spol ?? ""}</td>
                  <td>${
                    row.datum_rodenja
                      ? new Date(row.datum_rodenja).toLocaleDateString("hr-HR")
                      : ""
                  }</td>
                  <td>${row.drzava_podrijetla ?? ""}</td>
                  <td>${row.aktivan_od ?? ""}</td>
                  <td>${row.broj_nagrada ?? ""}</td>
                  <td>${row.nagrada_oscar ?? ""}</td>
                  <td>${row.nagrada_golden_globe ?? ""}</td>
                  <td>${row.nagrada_bafta ?? ""}</td>
                </tr>`;
            })
            .join("");

          tableBody.innerHTML = rows;
          countInfo.textContent = "Prikazano: " + data.length;
        }

        updateDownloadLinks();
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        fetchData();
      });

      resetBtn.addEventListener("click", () => {
        qInput.value = "";
        fieldSelect.value = "all";
        fetchData();
      });

      fetchData();

      let t = null;
      qInput.addEventListener("input", () => {
        clearTimeout(t);
        t = setTimeout(fetchData, 300);
      });
      fieldSelect.addEventListener("change", fetchData);
    </script>
    <script>
      const authBadge = document.getElementById("authBadge");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const profileBtn = document.getElementById("profileBtn");
      const refreshBtn = document.getElementById("refreshBtn");

      async function loadAuth() {
        try {
          const res = await fetch("/auth-status", {
            credentials: "same-origin",
          });
          const data = await res.json();

          if (data && data.authenticated) {
            authBadge.textContent = "Prijavljeni ste";
            loginBtn.style.display = "none";
            logoutBtn.style.display = "inline-block";
            profileBtn.style.display = "inline-block";
            refreshBtn.style.display = "inline-block";
          } else {
            authBadge.textContent = "Niste prijavljeni";
            loginBtn.style.display = "inline-block";
            logoutBtn.style.display = "none";
            profileBtn.style.display = "none";
            refreshBtn.style.display = "none";
          }
        } catch (e) {
          authBadge.textContent = "Nije moguće provjeriti prijavu";
          loginBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
          profileBtn.style.display = "none";
          refreshBtn.style.display = "none";
        }
      }

      loadAuth();
      const toast = document.getElementById("toast");

      function showToast(msg) {
        toast.textContent = msg;
        toast.style.display = "inline-block";
        clearTimeout(window.__t);
        window.__t = setTimeout(() => (toast.style.display = "none"), 2000);
      }

      refreshBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        try {
          const res = await fetch("/api/osvjezi-preslike", {
            credentials: "same-origin",
          });

          if (res.status === 401) {
            showToast("Potrebna je prijava.");
            return;
          }
          if (!res.ok) {
            showToast("Greška pri osvježavanju.");
            return;
          }

          showToast("Osvježeno");
        } catch (err) {
          showToast("Greška pri osvježavanju.");
        }
      });
    </script>
  </body>
</html>
